{% load cms_tags sekizai_tags staticfiles %}


{% block content %}

  {% addtoblock "css" %}
    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{% static 'cms_lab_publications/app.css' %}">
  {% endaddtoblock %}

  <div id="publication-list">
    <form style="display:inline;">
      <h4>
        {{ instance.publication_set.label }}
        <button type="button" class="btn btn-default btn-xs" onclick="$( '.pub-tags-select' ).val(null).trigger('change'); $( '#pub-search' ).val(null); pubList.search(); $( '#search-filter-pubs' ).toggle(); $( '#pub-search' ).focus(); $(this).blur()">
          <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
        </button>
      </h4>

      <div id="search-filter-pubs" class="row" style="display: none;">
        <div class="col-xs-9 col-sm-5 search-container">
          <input id="pub-search" class="search form-control" type="text" placeholder="Search Publications" />
        </div>

        <div class="col-xs-1 col-sm-push-5">
          <button type="button" class="btn btn-danger" onclick="$( '.pub-tags-select' ).val(null).trigger('change'); $( '#pub-search' ).val(null); pubList.search(); $( '#pub-search' ).focus();"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
        </div>

        <div class="col-xs-9 col-sm-5 col-sm-pull-1 filter-container">
          <select class="pub-tags-select" multiple="multiple" style="width: 100%;">
            {% for id, tag in pub_set_tags.items %}
              <option value="{{ id }}">{{ tag }}</option>
            {% endfor %}
          </select>
        </div>

      </div>

      <ul class="list" style="list-style: none; padding-left: 0;">
        {% for publication in instance.publication_set.publications.all %}
          <li>
            <p class="citation">
              {{ publication.citation }}
              <span class="btn-group btn-group-xs" role="group" aria-label="publication-buttons">
                {% include "cms_lab_publications/_buttons.html" %}
              </span>
            </p>

            <!-- Hidden search/filter fields -->
            <p class="abstract" style="display: none;">{{ publication.abstract }}</p>
            <p class="authors" style="display: none;">{{ publication.authors }}</p>
            <p class="tags" style="display: none;">{% for tag in publication.tags.values %}{{ tag.id }} {% endfor %}</p>
          </li>
        {% endfor %}
      </ul>

      {% if instance.publication_set.pagination %}
        <div class="text-center">
          <ul class="pagination"></ul>
        </div>
      {% endif %}
    </form>
  </div>

  {% for publication in instance.publication_set.publications.all %}
    {% include "cms_lab_publications/_modal.html" %}
  {% endfor %}

  {% addtoblock "js" %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>

    <script>
      // Based on: http://stackoverflow.com/a/9204307/996114
      function containsAll(query, target) {
          var success;

          if (query === null) {
            success = true;
          }
          else{
            success = $.grep(query, function(n, i) {
                return $.inArray(n, target) !== -1;
            }).length === query.length;
          };

          return success;
      }

      function filterByTags(list) {
        pubList.filter(function(item) {
          var query = $( ".pub-tags-select" ).val();
          var pub_tags = item.values().tags.trim().split(/\s+/);
          if (containsAll(query, pub_tags)) {
            return true;
          } else {
            return false;
          }
        });
      }

      $( ".pub-tags-select" ).change(function() {
        filterByTags(pubList);
      });

      $( "#pub-search" ).keyup(function() {
        filterByTags(pubList);
      });
    </script>

    <script type="text/javascript">
      $(".pub-tags-select").select2({
          placeholder: "Filter Keywords",
      });
    </script>

    <script src="{% static 'cms_lab_publications/js/list.min.js' %}"></script>

    {% if instance.publication_set.pagination %}
      <script src="{% static 'cms_lab_publications/js/list.pagination.min.js' %}"></script>
    {% endif %}

    <script>
      var options = {
        valueNames: [ 'abstract', 'authors', 'citation', 'tags' ],

        {% if instance.publication_set.pagination %}
          page: {{ instance.publication_set.pagination }},
          plugins: [
            ListPagination({})
          ],
        {% endif %}

      };
      var pubList = new List('publication-list', options);
    </script>

    <script>
      // Make Filter Combo box style more consistent with Search box
      $('.select2-selection__rendered').css('padding', '0 12px');
    </script>
  {% endaddtoblock %}

{% endblock content %}
