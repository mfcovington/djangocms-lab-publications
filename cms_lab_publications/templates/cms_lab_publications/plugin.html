{% load cms_tags sekizai_tags staticfiles %}


{% block content %}

  {% addtoblock "css" %}
    <link rel="stylesheet" type="text/css" href="{% static 'cms_lab_publications/app.css' %}">
    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" rel="stylesheet" />
  {% endaddtoblock %}

  <div id="publication-list">
    <form style="display:inline;">
      <h4>{{ instance.publication_set.label }}</h4>

      <div class="form-group has-feedback">
        <input id="pub-search" class="search form-control" type="text" placeholder="Search" />
        <i class="glyphicon glyphicon-search form-control-feedback"></i>
      </div>

      <select class="pub-tags-select" multiple="multiple" style="width: 100%;">
        {% for id, tag in pub_set_tags.items %}
          <option value="{{ id }}">{{ tag }}</option>
        {% endfor %}
      </select>

      <button type="button" class="btn btn-danger btn-sm" onclick="$( '.pub-tags-select' ).val(null).trigger('change'); $( '#pub-search' ).val(null); pubList.search();">Reset Search/Filter</button>

      <ul class="list" style="list-style: none; padding-left: 0;">
        {% for publication in instance.publication_set.publications.all %}
          <li>
            <p class="citation">
              {{ publication.citation }}
              <span class="btn-group btn-group-xs" role="group" aria-label="publication-buttons">
                {% include "cms_lab_publications/_buttons.html" %}
              </span>
            </p>

            <!-- Hidden search fields -->
            <p class="abstract" style="display: none;">{{ publication.abstract }}</p>
            <p class="authors" style="display: none;">{{ publication.authors }}</p>
            <p class="tags" style="display: none;">{% for tag in publication.tags.values %}{{ tag.id }} {% endfor %}</p>
          </li>
        {% endfor %}
      </ul>

      {% if instance.publication_set.pagination %}
        <div class="text-center">
          <ul class="pagination"></ul>
        </div>
      {% endif %}
    </form>
  </div>

  {% for publication in instance.publication_set.publications.all %}
    {% include "cms_lab_publications/_modal.html" %}
  {% endfor %}

  {% addtoblock "js" %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>

    <script>
      // Based on: http://stackoverflow.com/a/9204307/996114
      function containsAll(query, target) {
          var success;

          if (query === null) {
            success = true;
          }
          else{
            success = $.grep(query, function(n, i) {
                return $.inArray(n, target) !== -1;
            }).length === query.length;
          };

          return success;
      }

      function filterByTags(list) {
        pubList.filter(function(item) {
          var query = $( ".pub-tags-select" ).val();
          var pub_tags = item.values().tags.trim().split(/\s+/);
          if (containsAll(query, pub_tags)) {
            return true;
          } else {
            return false;
          }
        });
      }

      $( ".pub-tags-select" ).change(function() {
        filterByTags(pubList);
      });

      $( "#pub-search" ).keyup(function() {
        filterByTags(pubList);
      });
    </script>

    <script type="text/javascript">
      $(".pub-tags-select").select2({
          placeholder: "Filter by Tags",
      });
    </script>

    <script src="{% static 'cms_lab_publications/js/list.min.js' %}"></script>

    {% if instance.publication_set.pagination %}
      <script src="{% static 'cms_lab_publications/js/list.pagination.min.js' %}"></script>
    {% endif %}

    <script>
      var options = {
        valueNames: [ 'abstract', 'authors', 'citation', 'tags' ],

        {% if instance.publication_set.pagination %}
          page: {{ instance.publication_set.pagination }},
          plugins: [
            ListPagination({})
          ],
        {% endif %}

      };
      var pubList = new List('publication-list', options);
    </script>
  {% endaddtoblock %}

{% endblock content %}
